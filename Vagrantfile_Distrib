# -*- mode: ruby -*-
# vi: set ft=ruby :

unless Vagrant.has_plugin?("vagrant-vbguest")
  raise "\n\nAmbiente de desenvolvimento não pode ser criado não foi encontrado o plugin vagrant-vbguest.\n"+
        "Para solucionar o problema, execute o seguinte comando no diretório raiz do projeto.\n\n"+
        "> vagrant plugin install vagrant-vbguest \n\n"
end

Vagrant.configure(2) do |config|

  # Box do vagrant contendo o ambiente de desenvolvimento do SEI
  config.vm.box = "processoeletronico/sei-2.6.0"

  # Usuários ssh de acesso à máquina virtual
  config.ssh.username = "vagrant"
  config.ssh.password = "vagrant"

  # Configuração do diretório local onde deverá estar disponibilizado os códigos-fontes do SEI (sei, sip, infra_php, infra_css, infra_js)
  config.vm.synced_folder ".", "/mnt/sei/src", mount_options: ["dmode=777", "fmode=777"]

  # Configuração do redirecionamento entre Máquina Virtual e Host
  # Necessário permissões de root para utilizar a porta 80 (> 1024)
  config.vm.network :forwarded_port, guest: 80,   host: 80   # SIP e SEI (Apache)
  config.vm.network :forwarded_port, guest: 3306, host: 3306 # Banco de Dados (Mysql)
  config.vm.network :forwarded_port, guest: 8080, host: 8080 # Jod Converter (Tomcat)
  config.vm.network :forwarded_port, guest: 8983, host: 8983 # Solr Indexer (Jetty)
  config.vm.network :forwarded_port, guest: 1080, host: 1080 # MailCatcher

  # Inicialização dos containers em caso de reinicialização da máquina host
  config.vm.provision "shell", run: "always", inline: "docker restart sei_solr && docker restart sei_jod && docker restart sei_smtp && docker restart sei_db && docker restart sei_www"
end
